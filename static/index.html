<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#5a9f7e">
    <title>Grocery Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html {
            -webkit-text-size-adjust: 100%;
        }

        body {
            min-height: 100vh;
            background: linear-gradient(135deg, #5a9f7e 0%, #8ec9a6 100%);
            font-family: system-ui, -apple-system, sans-serif;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .app {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #5a9f7e 0%, #8ec9a6 100%);
            color: white;
            padding: 25px;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 13px;
        }

        .content {
            padding: 20px;
        }

        /* Add Item Form */
        .add-form {
            margin-bottom: 25px;
        }

        .add-form-main {
            display: flex;
            gap: 10px;
        }

        .add-form input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
        }

        .add-form input:focus {
            outline: none;
            border-color: #5a9f7e;
        }

        .add-form button {
            padding: 12px 25px;
            background: #5a9f7e;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
        }

        .add-form button:hover {
            background: #4a8a6a;
        }

        /* Section Headers */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }

        .section-header h2 {
            font-size: 18px;
            color: #333;
        }

        .section-header .count {
            background: #5a9f7e;
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 13px;
        }

        /* Shopping List */
        .shopping-list {
            list-style: none;
            margin-bottom: 30px;
        }

        .store-group-header {
            padding: 10px 15px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            margin: 15px 0 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .store-group-header:first-child {
            margin-top: 0;
        }

        .store-group-count {
            padding: 2px 10px;
            border-radius: 12px;
            font-size: 12px;
            color: white;
        }

        .list-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 10px;
            gap: 12px;
        }

        .list-item:hover {
            background: #f0f0f0;
        }

        .item-info {
            flex: 1;
            min-width: 0;
        }

        .item-name {
            font-size: 15px;
            font-weight: 600;
            color: #333;
            margin-bottom: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .item-meta {
            font-size: 11px;
            color: #666;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .item-meta .frequency {
            color: #5a9f7e;
            font-weight: 500;
            cursor: pointer;
            padding: 2px 8px;
            background: #e8f4ed;
            border-radius: 10px;
            font-size: 11px;
        }

        .item-meta .frequency:hover {
            background: #d4e8db;
        }

        .item-meta .frequency-target {
            color: #666;
            font-size: 10px;
        }

        .item-meta .price {
            color: #e67e22;
            font-weight: 500;
        }

        .bought-btn {
            padding: 8px 16px;
            background: #6ab88c;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .bought-btn:hover {
            background: #5aa87c;
            transform: scale(1.05);
        }

        .item-actions {
            display: flex;
            gap: 6px;
        }

        .action-btn {
            padding: 5px 8px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 10px;
        }

        .delete-btn {
            background: #e74c3c;
            color: white;
        }

        /* Buy Again Section */
        .buy-again-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .buy-again-section h3 {
            font-size: 16px;
            color: #333;
            margin-bottom: 15px;
        }

        .frequent-items {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .frequent-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .frequent-item:hover {
            border-color: #5a9f7e;
            background: #e8f4ed;
        }

        .frequent-item .name {
            font-weight: 500;
            font-size: 13px;
        }

        .frequent-item .stats {
            font-size: 10px;
            color: #666;
        }

        .frequent-item .add-btn {
            background: #5a9f7e;
            color: white;
            border: none;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .due-soon {
            border-color: #ff6b6b !important;
            background: #fff5f5 !important;
        }

        .due-soon .stats {
            color: #e74c3c;
            font-weight: 500;
        }

        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 30px;
            color: #999;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 12px;
            max-width: 400px;
            width: 90%;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            font-size: 18px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .history-list {
            list-style: none;
            max-height: 300px;
            overflow-y: auto;
        }

        .history-item {
            padding: 10px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            font-size: 14px;
        }

        .history-item:last-child {
            border-bottom: none;
        }

        /* User/Store selectors */
        .user-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background: #f0f0f0;
            border-bottom: 1px solid #e0e0e0;
        }

        .user-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-selector label {
            font-size: 13px;
            color: #666;
        }

        .user-selector select {
            padding: 6px 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 13px;
        }

        .manage-btn {
            padding: 5px 10px;
            background: #666;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        .manage-btn:hover {
            background: #555;
        }

        .options-row {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 8px;
        }

        .options-row select {
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 13px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: #666;
            cursor: pointer;
        }

        .checkbox-label input {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .form-error {
            color: #e74c3c;
            font-size: 13px;
            margin-top: 8px;
            padding: 8px 12px;
            background: #ffeaea;
            border-radius: 6px;
            display: none;
        }

        .form-error.show {
            display: block;
        }

        /* Store Tabs */
        .store-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .store-tab {
            padding: 8px 16px;
            background: #f0f0f0;
            border: 2px solid #e0e0e0;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .store-tab:hover {
            border-color: #5a9f7e;
        }

        .store-tab.active {
            background: #5a9f7e;
            color: white;
            border-color: #5a9f7e;
        }

        .store-tab .count {
            background: rgba(0,0,0,0.15);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            margin-left: 6px;
        }

        .store-tab.active .count {
            background: rgba(255,255,255,0.25);
        }

        .item-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 500;
        }

        .store-badge {
            background: #e3f2fd;
            color: #1565c0;
        }

        .user-badge {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .occasional-badge {
            background: #fff3e0;
            color: #e65100;
        }

        .store-badge {
            cursor: pointer;
            position: relative;
        }

        .store-badge:hover {
            opacity: 0.8;
        }

        .no-store-badge {
            background: #f5f5f5;
            color: #999;
            cursor: pointer;
        }

        .store-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            background: #ffffff;
            border: 2px solid #333;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 1000;
            min-width: 160px;
            margin-top: 5px;
        }

        .store-dropdown-item {
            padding: 12px 15px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #333;
            background: #ffffff;
            border-bottom: 1px solid #e0e0e0;
        }

        .store-dropdown-item:first-child {
            border-radius: 6px 6px 0 0;
        }

        .store-dropdown-item:last-child {
            border-bottom: none;
            border-radius: 0 0 6px 6px;
        }

        .store-dropdown-item:hover {
            background: #f0f0f0;
        }

        .store-dropdown-item.active {
            background: #5a9f7e;
            color: white;
        }

        .store-dropdown-item.active:hover {
            background: #4a8a6a;
        }

        .last-purchased {
            color: #888;
            font-style: italic;
        }

        /* Manage modal */
        .manage-list {
            list-style: none;
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 15px;
        }

        .manage-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 10px;
            background: #f5f5f5;
            border-radius: 5px;
            margin-bottom: 5px;
        }

        .manage-item-buttons {
            display: flex;
            gap: 5px;
        }

        .edit-btn {
            background: #3498db;
            color: white;
        }

        .details-btn {
            background: #9b59b6;
            color: white;
        }

        /* Item Details Panel */
        .item-details {
            display: none;
            background: #f0f4f8;
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            width: 100%;
        }

        .item-details.show {
            display: block;
        }

        .item-details-row {
            margin-bottom: 10px;
        }

        .item-details-row:last-child {
            margin-bottom: 0;
        }

        .item-details-row label {
            display: block;
            font-size: 11px;
            color: #666;
            margin-bottom: 4px;
            font-weight: 600;
        }

        .item-details-row input,
        .item-details-row textarea {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
            font-family: inherit;
        }

        .item-details-row textarea {
            resize: vertical;
            min-height: 60px;
        }

        .item-details-row input:focus,
        .item-details-row textarea:focus {
            outline: none;
            border-color: #5a9f7e;
        }

        .item-image-preview {
            max-width: 100px;
            max-height: 100px;
            border-radius: 6px;
            margin-top: 8px;
            display: block;
        }

        .item-thumbnail {
            width: 40px;
            height: 40px;
            border-radius: 6px;
            object-fit: cover;
            flex-shrink: 0;
        }

        .save-details-btn {
            background: #5a9f7e;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            margin-top: 10px;
        }

        .save-details-btn:hover {
            background: #4a8a6a;
        }

        .has-details-indicator {
            width: 8px;
            height: 8px;
            background: #9b59b6;
            border-radius: 50%;
            display: inline-block;
            margin-left: 5px;
        }

        /* Item Action Menu */
        .item-menu-btn {
            background: #f0f0f0;
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            color: #666;
            letter-spacing: 2px;
        }

        .item-menu-btn:hover {
            background: #e0e0e0;
        }

        .item-menu {
            position: fixed;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            z-index: 1000;
            min-width: 140px;
            overflow: hidden;
        }

        .item-menu-option {
            display: block;
            width: 100%;
            padding: 12px 16px;
            border: none;
            background: none;
            text-align: left;
            cursor: pointer;
            font-size: 14px;
            color: #333;
        }

        .item-menu-option:hover {
            background: #f5f5f5;
        }

        .item-menu-option.delete {
            color: #e74c3c;
        }

        .item-menu-option.delete:hover {
            background: #ffeaea;
        }

        .item-primary-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .na-btn {
            padding: 8px 12px;
            background: #f5f5f5;
            color: #888;
            border: 1px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
        }

        .na-btn:hover {
            background: #e67e22;
            color: white;
            border-color: #e67e22;
        }

        .menu-wrapper {
            position: relative;
        }

        .manage-add {
            display: flex;
            gap: 10px;
        }

        .manage-add input {
            flex: 1;
            padding: 8px 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 13px;
        }

        .manage-add button {
            padding: 8px 15px;
            background: #5a9f7e;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
        }

        /* Undo Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }

        .toast.show {
            opacity: 1;
            pointer-events: auto;
        }

        .toast-message {
            font-size: 14px;
        }

        .toast-undo {
            background: none;
            border: 1px solid white;
            color: white;
            padding: 5px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
        }

        .toast-undo:hover {
            background: white;
            color: #333;
        }

        /* Mobile Optimizations */
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }

            .header {
                padding: 20px 15px;
            }

            .header h1 {
                font-size: 22px;
            }

            .content {
                padding: 15px;
            }

            /* User bar - stack on mobile */
            .user-bar {
                flex-direction: column;
                gap: 10px;
                padding: 12px 15px;
            }

            .user-selector {
                width: 100%;
                justify-content: space-between;
            }

            .user-selector select {
                flex: 1;
                padding: 10px;
                font-size: 16px; /* Prevents zoom on iOS */
            }

            /* Add form - larger inputs */
            .add-form-main {
                flex-direction: column;
            }

            .add-form input {
                font-size: 16px; /* Prevents zoom on iOS */
                padding: 14px 15px;
            }

            .add-form button {
                padding: 14px;
                font-size: 16px;
            }

            .options-row {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }

            .options-row select {
                font-size: 16px;
                padding: 12px;
            }

            .checkbox-label {
                font-size: 14px;
                padding: 8px 0;
            }

            .checkbox-label input {
                width: 20px;
                height: 20px;
            }

            /* Store tabs - scrollable */
            .store-tabs {
                overflow-x: auto;
                flex-wrap: nowrap;
                padding-bottom: 5px;
                -webkit-overflow-scrolling: touch;
            }

            .store-tab {
                flex-shrink: 0;
                padding: 10px 16px;
                font-size: 14px;
            }

            /* List items - compact on mobile */
            .list-item {
                padding: 12px;
                flex-wrap: wrap;
                gap: 8px;
            }

            .item-name {
                font-size: 16px;
            }

            .item-meta {
                font-size: 12px;
                gap: 8px;
            }

            .item-badge {
                padding: 4px 10px;
                font-size: 11px;
            }

            /* Primary actions on mobile */
            .item-primary-actions {
                justify-content: flex-end;
                gap: 6px;
            }

            .bought-btn {
                padding: 8px 14px;
                font-size: 13px;
                min-height: 36px;
            }

            .na-btn {
                min-height: 36px;
                padding: 6px 10px;
                font-size: 11px;
            }

            .item-menu-btn {
                min-height: 36px;
                padding: 6px 10px;
            }

            /* Buy Again section */
            .buy-again-section {
                padding: 15px;
            }

            .frequent-item {
                padding: 12px 15px;
            }

            .frequent-item .name {
                font-size: 14px;
            }

            .frequent-item .add-btn {
                width: 32px;
                height: 32px;
                font-size: 18px;
            }

            /* Dropdowns - full width on mobile */
            .store-dropdown {
                min-width: 200px;
            }

            .store-dropdown-item {
                padding: 14px 15px;
                font-size: 15px;
            }

            /* Modal - better mobile fit */
            .modal-content {
                width: 95%;
                max-height: 85vh;
                overflow-y: auto;
            }

            .manage-add input {
                font-size: 16px;
                padding: 12px;
            }

            .manage-add button {
                padding: 12px 20px;
            }

            /* Toast - bottom safe area */
            .toast {
                bottom: 30px;
                left: 10px;
                right: 10px;
                transform: none;
                width: auto;
            }

            /* Store group header */
            .store-group-header {
                padding: 12px 15px;
                font-size: 15px;
            }

            /* Section header */
            .section-header h2 {
                font-size: 16px;
            }
        }

        /* Extra small screens */
        @media (max-width: 380px) {
            .list-item {
                flex-direction: column;
                align-items: stretch;
            }

            .item-info {
                width: 100%;
            }

            .bought-btn {
                width: 100%;
                margin-top: 10px;
            }

            .item-actions {
                justify-content: space-between;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="app">
            <div class="header">
                <h1>Grocery Tracker</h1>
                <p>Track purchases and predict when you'll need items again</p>
            </div>

            <div class="user-bar">
                <div class="user-selector">
                    <label>Shopping as:</label>
                    <select id="currentUser" onchange="saveCurrentUser()">
                        <option value="">Select user...</option>
                    </select>
                    <button class="manage-btn" onclick="openManageModal('users')">Manage Users</button>
                </div>
                <button class="manage-btn" onclick="openManageModal('stores')">Manage Stores</button>
            </div>

            <div class="content">
                <div class="add-form">
                    <div class="add-form-main">
                        <input type="text" id="itemName" placeholder="Add item to shopping list..." onkeypress="if(event.key==='Enter')addItem()">
                        <button onclick="addItem()">Add</button>
                    </div>
                    <div class="options-row">
                        <select id="itemStore">
                            <option value="">Select store...</option>
                        </select>
                        <label class="checkbox-label">
                            <input type="checkbox" id="itemOccasional">
                            Occasional (seasonal, one-time)
                        </label>
                    </div>
                    <div class="form-error" id="formError"></div>
                </div>

                <div class="store-tabs" id="storeTabs"></div>

                <div class="section-header">
                    <h2>Shopping List</h2>
                    <span class="count" id="listCount">0 items</span>
                </div>

                <ul class="shopping-list" id="shoppingList">
                    <li class="empty-state">Loading...</li>
                </ul>

                <div class="buy-again-section" id="buyAgainSection" style="display:none;">
                    <h3>Buy Again</h3>
                    <div class="frequent-items" id="frequentItems"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Purchase History Modal -->
    <div class="modal" id="historyModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="historyTitle">Purchase History</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <ul class="history-list" id="historyList"></ul>
        </div>
    </div>

    <!-- Undo Toast -->
    <div class="toast" id="undoToast">
        <span class="toast-message" id="toastMessage">Item marked as bought</span>
        <button class="toast-undo" onclick="undoLastAction()">Undo</button>
    </div>

    <!-- Manage Users/Stores Modal --><div class="modal" id="manageModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="manageTitle">Manage</h3>
                <button class="modal-close" onclick="closeManageModal()">&times;</button>
            </div>
            <ul class="manage-list" id="manageList"></ul>
            <div class="manage-add">
                <input type="text" id="manageInput" placeholder="Enter name..." onkeypress="if(event.key==='Enter')addManageItem()">
                <button onclick="addManageItem()">Add</button>
            </div>
        </div>
    </div>

    <script>
        let listItems = [];
        let frequentItems = [];
        let users = [];
        let stores = [];
        let manageType = 'users';
        let lastAction = null;
        let toastTimeout = null;
        let selectedStoreFilter = 'all';

        async function fetchData() {
            try {
                const [listRes, frequentRes, usersRes, storesRes] = await Promise.all([
                    fetch('/api/items/on-list'),
                    fetch('/api/items/frequent'),
                    fetch('/api/users'),
                    fetch('/api/stores')
                ]);
                listItems = await listRes.json();
                frequentItems = await frequentRes.json();
                users = await usersRes.json();
                stores = await storesRes.json();
                renderUserSelector();
                renderStoreSelector();
                render();
            } catch (error) {
                console.error('Failed to fetch:', error);
            }
        }

        function renderUserSelector() {
            const select = document.getElementById('currentUser');
            const currentValue = select.value || localStorage.getItem('currentUserId') || '';
            select.innerHTML = '<option value="">Select user...</option>' +
                users.map(u => `<option value="${u.id}">${escapeHtml(u.name)}</option>`).join('');
            select.value = currentValue;
        }

        function renderStoreSelector() {
            const select = document.getElementById('itemStore');
            select.innerHTML = '<option value="">No store selected</option>' +
                stores.map(s => `<option value="${s.id}">${escapeHtml(s.name)}</option>`).join('');
        }

        function renderStoreTabs() {
            const tabsEl = document.getElementById('storeTabs');

            // Count items per store
            const allCount = listItems.length;
            const noStoreCount = listItems.filter(i => !i.store_id).length;
            const storeCounts = {};
            stores.forEach(s => {
                storeCounts[s.id] = listItems.filter(i => i.store_id === s.id).length;
            });

            // Only show tabs if there are stores with items
            const storesWithItems = stores.filter(s => storeCounts[s.id] > 0);
            if (storesWithItems.length === 0 && noStoreCount === allCount) {
                tabsEl.style.display = 'none';
                return;
            }
            tabsEl.style.display = 'flex';

            let html = `<button class="store-tab ${selectedStoreFilter === 'all' ? 'active' : ''}" onclick="filterByStore('all')">All<span class="count">${allCount}</span></button>`;

            stores.forEach(s => {
                if (storeCounts[s.id] > 0) {
                    html += `<button class="store-tab ${selectedStoreFilter === s.id ? 'active' : ''}" onclick="filterByStore(${s.id})">${escapeHtml(s.name)}<span class="count">${storeCounts[s.id]}</span></button>`;
                }
            });

            if (noStoreCount > 0 && storesWithItems.length > 0) {
                html += `<button class="store-tab ${selectedStoreFilter === 'none' ? 'active' : ''}" onclick="filterByStore('none')">No Store<span class="count">${noStoreCount}</span></button>`;
            }

            tabsEl.innerHTML = html;
        }

        function filterByStore(storeId) {
            selectedStoreFilter = storeId;
            render();
        }

        function getFilteredItems(items) {
            if (selectedStoreFilter === 'all') return items;
            if (selectedStoreFilter === 'none') return items.filter(i => !i.store_id);
            return items.filter(i => i.store_id === selectedStoreFilter);
        }

        function saveCurrentUser() {
            const userId = document.getElementById('currentUser').value;
            localStorage.setItem('currentUserId', userId);
        }

        function getCurrentUserId() {
            return document.getElementById('currentUser').value || null;
        }

        function showUndoToast(message, action) {
            lastAction = action;
            document.getElementById('toastMessage').textContent = message;
            const toast = document.getElementById('undoToast');
            toast.classList.add('show');

            if (toastTimeout) clearTimeout(toastTimeout);
            toastTimeout = setTimeout(() => {
                toast.classList.remove('show');
                lastAction = null;
            }, 5000);
        }

        async function undoLastAction() {
            if (!lastAction) return;

            const toast = document.getElementById('undoToast');
            toast.classList.remove('show');
            if (toastTimeout) clearTimeout(toastTimeout);

            if (lastAction.type === 'bought') {
                await fetch(`/api/items/${lastAction.itemId}/add-to-list`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
            }

            lastAction = null;
            fetchData();
        }

        async function addItem() {
            const nameInput = document.getElementById('itemName');
            const storeSelect = document.getElementById('itemStore');
            const occasionalCheck = document.getElementById('itemOccasional');
            const errorEl = document.getElementById('formError');

            const name = nameInput.value.trim();
            if (!name) return;

            const store_id = storeSelect.value || null;
            const added_by = getCurrentUserId();
            const occasional = occasionalCheck.checked;

            // Validate user and store selection
            const errors = [];
            if (!added_by) errors.push('select a user');
            if (!store_id) errors.push('select a store');

            if (errors.length > 0) {
                errorEl.textContent = 'Please ' + errors.join(' and ') + ' before adding an item.';
                errorEl.classList.add('show');
                return;
            }

            errorEl.classList.remove('show');

            await fetch('/api/items', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, store_id, added_by, occasional })
            });

            nameInput.value = '';
            occasionalCheck.checked = false;
            fetchData();
        }

        async function markBought(itemId) {
            const item = listItems.find(i => i.id === itemId);
            const itemName = item ? item.name : 'Item';

            const user_id = getCurrentUserId();
            await fetch(`/api/items/${itemId}/bought`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id })
            });

            showUndoToast(`"${itemName}" marked as bought`, { type: 'bought', itemId });
            fetchData();
        }

        async function markNotAvailable(itemId) {
            const item = listItems.find(i => i.id === itemId);
            const itemName = item ? item.name : 'Item';

            const user_id = getCurrentUserId();
            await fetch(`/api/items/${itemId}/not-available`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id })
            });

            showUndoToast(`"${itemName}" marked as not available`, { type: 'not_available', itemId });
            fetchData();
        }

        async function addToList(itemId) {
            await fetch(`/api/items/${itemId}/add-to-list`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({})
            });
            fetchData();
        }

        async function deleteItem(itemId) {
            if (!confirm('Delete this item permanently?')) return;
            await fetch(`/api/items/${itemId}`, { method: 'DELETE' });
            fetchData();
        }

        async function editItem(itemId, currentName) {
            const newName = prompt('Edit item name:', currentName);
            if (!newName || newName.trim() === '' || newName.trim() === currentName) return;

            await fetch(`/api/items/${itemId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: newName.trim() })
            });
            fetchData();
        }

        function toggleDetails(itemId) {
            const panel = document.getElementById(`details-${itemId}`);
            panel.classList.toggle('show');
        }

        async function saveDetails(itemId) {
            const notes = document.getElementById(`notes-${itemId}`).value;

            await fetch(`/api/items/${itemId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ notes })
            });

            // Close the panel and refresh
            document.getElementById(`details-${itemId}`).classList.remove('show');
            fetchData();
        }

        async function showHistory(itemId, name) {
            document.getElementById('historyTitle').textContent = `${name} - History`;
            document.getElementById('historyModal').classList.add('active');

            const [purchaseRes, storeRes] = await Promise.all([
                fetch(`/api/items/${itemId}/purchases`),
                fetch(`/api/items/${itemId}/store-history`)
            ]);
            const purchases = await purchaseRes.json();
            const storeChanges = await storeRes.json();

            const list = document.getElementById('historyList');
            let html = '';

            // Purchase history
            html += '<li style="font-weight:600;padding:10px 0 5px;border-bottom:none;">History</li>';
            if (purchases.length === 0) {
                html += '<li class="empty-state" style="padding:10px 0;">No history yet</li>';
            } else {
                html += purchases.map(h => `
                    <li class="history-item">
                        <span>${new Date(h.purchased_at).toLocaleDateString('en-US', {
                            weekday: 'short', month: 'short', day: 'numeric', year: 'numeric'
                        })}</span>
                        ${h.not_available ? '<span style="color:#e67e22;font-weight:500;">Not available</span>' : (h.price ? `<span>$${h.price.toFixed(2)}</span>` : '<span style="color:#6ab88c;">Bought</span>')}
                    </li>
                `).join('');
            }

            // Store change history
            if (storeChanges.length > 0) {
                html += '<li style="font-weight:600;padding:15px 0 5px;border-bottom:none;">Store Changes</li>';
                html += storeChanges.map(h => `
                    <li class="history-item">
                        <span>${h.from_store_name || 'No store'} â†’ ${h.to_store_name || 'No store'}</span>
                        <span style="color:#888;font-size:12px;">${new Date(h.changed_at).toLocaleDateString('en-US', {
                            month: 'short', day: 'numeric'
                        })}${h.changed_by_name ? ` by ${h.changed_by_name}` : ''}</span>
                    </li>
                `).join('');
            }

            list.innerHTML = html;
        }

        function closeModal() {
            document.getElementById('historyModal').classList.remove('active');
        }

        function openManageModal(type) {
            manageType = type;
            document.getElementById('manageTitle').textContent = type === 'users' ? 'Manage Users' : 'Manage Stores';
            document.getElementById('manageInput').placeholder = type === 'users' ? 'Enter user name...' : 'Enter store name...';
            document.getElementById('manageModal').classList.add('active');
            renderManageList();
        }

        function closeManageModal() {
            document.getElementById('manageModal').classList.remove('active');
        }

        function renderManageList() {
            const list = document.getElementById('manageList');
            const items = manageType === 'users' ? users : stores;
            if (items.length === 0) {
                list.innerHTML = `<li class="empty-state">No ${manageType} yet</li>`;
            } else {
                list.innerHTML = items.map(item => `
                    <li class="manage-item">
                        <span>${escapeHtml(item.name)}</span>
                        <div class="manage-item-buttons">
                            <button class="action-btn edit-btn" onclick="editManageItem(${item.id}, '${escapeHtml(item.name)}')">Edit</button>
                            <button class="action-btn delete-btn" onclick="deleteManageItem(${item.id})">Delete</button>
                        </div>
                    </li>
                `).join('');
            }
        }

        async function addManageItem() {
            const input = document.getElementById('manageInput');
            const name = input.value.trim();
            if (!name) return;

            const endpoint = manageType === 'users' ? '/api/users' : '/api/stores';
            await fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name })
            });

            input.value = '';
            await fetchData();
            renderManageList();
        }

        async function deleteManageItem(id) {
            if (!confirm(`Delete this ${manageType.slice(0, -1)}?`)) return;
            const endpoint = manageType === 'users' ? `/api/users/${id}` : `/api/stores/${id}`;
            await fetch(endpoint, { method: 'DELETE' });
            await fetchData();
            renderManageList();
        }

        async function editManageItem(id, currentName) {
            const newName = prompt(`Edit ${manageType.slice(0, -1)} name:`, currentName);
            if (!newName || newName.trim() === '' || newName.trim() === currentName) return;

            const endpoint = manageType === 'users' ? `/api/users/${id}` : `/api/stores/${id}`;
            await fetch(endpoint, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: newName.trim() })
            });
            await fetchData();
            renderManageList();
        }

        let activeDropdown = null;
        let activeItemMenu = null;

        function toggleItemMenu(event, itemId) {
            event.stopPropagation();
            closeItemMenu();
            const menu = document.getElementById(`menu-${itemId}`);
            const btn = event.target;
            const rect = btn.getBoundingClientRect();

            if (menu.style.display === 'none') {
                menu.style.display = 'block';
                // Position menu above or below button depending on space
                const menuHeight = menu.offsetHeight;
                const spaceBelow = window.innerHeight - rect.bottom;

                if (spaceBelow < menuHeight + 10) {
                    // Show above
                    menu.style.top = (rect.top - menuHeight - 5) + 'px';
                } else {
                    // Show below
                    menu.style.top = (rect.bottom + 5) + 'px';
                }
                menu.style.right = (window.innerWidth - rect.right) + 'px';
                activeItemMenu = menu;
            }
        }

        function closeItemMenu() {
            if (activeItemMenu) {
                activeItemMenu.style.display = 'none';
                activeItemMenu = null;
            }
        }

        function showStoreDropdown(event, itemId, currentStoreId) {
            event.stopPropagation();
            closeStoreDropdown();

            const badge = event.target;
            const rect = badge.getBoundingClientRect();

            const dropdown = document.createElement('div');
            dropdown.className = 'store-dropdown';
            dropdown.id = 'storeDropdown';
            dropdown.style.position = 'fixed';
            dropdown.style.top = (rect.bottom + 5) + 'px';
            dropdown.style.left = rect.left + 'px';

            let html = `<div class="store-dropdown-item ${!currentStoreId ? 'active' : ''}" onclick="changeItemStore(${itemId}, null)">No store</div>`;
            stores.forEach(s => {
                html += `<div class="store-dropdown-item ${currentStoreId === s.id ? 'active' : ''}" onclick="changeItemStore(${itemId}, ${s.id})">${escapeHtml(s.name)}</div>`;
            });

            dropdown.innerHTML = html;
            document.body.appendChild(dropdown);
            activeDropdown = dropdown;
        }

        function closeStoreDropdown() {
            if (activeDropdown) {
                activeDropdown.remove();
                activeDropdown = null;
            }
        }

        async function changeItemStore(itemId, newStoreId) {
            closeStoreDropdown();
            const changed_by = getCurrentUserId();
            await fetch(`/api/items/${itemId}/store`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ store_id: newStoreId, changed_by })
            });
            fetchData();
        }

        const frequencyOptions = [
            { days: null, label: 'Auto (from purchases)' },
            { days: 7, label: 'Weekly' },
            { days: 14, label: 'Every 2 weeks' },
            { days: 21, label: 'Every 3 weeks' },
            { days: 30, label: 'Monthly' },
            { days: 60, label: 'Every 2 months' }
        ];

        function showFrequencyDropdown(event, itemId, currentFrequency) {
            event.stopPropagation();
            closeStoreDropdown();

            const badge = event.target;
            const rect = badge.getBoundingClientRect();

            const dropdown = document.createElement('div');
            dropdown.className = 'store-dropdown';
            dropdown.id = 'storeDropdown';
            dropdown.style.position = 'fixed';
            dropdown.style.top = (rect.bottom + 5) + 'px';
            dropdown.style.left = rect.left + 'px';

            let html = frequencyOptions.map(opt =>
                `<div class="store-dropdown-item ${currentFrequency === opt.days ? 'active' : ''}" onclick="setItemFrequency(${itemId}, ${opt.days})">${opt.label}</div>`
            ).join('');

            dropdown.innerHTML = html;
            document.body.appendChild(dropdown);
            activeDropdown = dropdown;
        }

        async function setItemFrequency(itemId, days) {
            closeStoreDropdown();
            await fetch(`/api/items/${itemId}/frequency`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ days })
            });
            fetchData();
        }

        // Close dropdowns when clicking outside or scrolling
        document.addEventListener('click', () => { closeStoreDropdown(); closeItemMenu(); });
        document.addEventListener('scroll', () => { closeStoreDropdown(); closeItemMenu(); }, true);

        function formatLastPurchased(dateStr) {
            if (!dateStr) return null;
            const date = new Date(dateStr);
            const now = new Date();
            const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));

            if (diffDays === 0) return 'Last bought today';
            if (diffDays === 1) return 'Last bought yesterday';
            if (diffDays < 7) return `Last bought ${diffDays} days ago`;
            if (diffDays < 30) return `Last bought ${Math.floor(diffDays / 7)} week${Math.floor(diffDays / 7) > 1 ? 's' : ''} ago`;
            return `Last bought ${date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`;
        }

        function formatFrequency(days) {
            if (!days) return null;
            if (days <= 7) return 'Weekly';
            if (days <= 14) return 'Every 2 weeks';
            if (days <= 21) return 'Every 3 weeks';
            if (days <= 35) return 'Monthly';
            return `Every ${days} days`;
        }

        function getDaysUntilDue(nextPurchase) {
            if (!nextPurchase) return null;
            const next = new Date(nextPurchase);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const diff = Math.ceil((next - today) / (1000 * 60 * 60 * 24));
            return diff;
        }

        function formatDueDate(nextPurchase) {
            const days = getDaysUntilDue(nextPurchase);
            if (days === null) return null;
            if (days < 0) return `${Math.abs(days)} days overdue`;
            if (days === 0) return 'Due today';
            if (days === 1) return 'Due tomorrow';
            if (days <= 7) return `Due in ${days} days`;
            return null;
        }

        // Pastel colors for stores (light for items, bold for headers)
        const storeColors = [
            { bg: '#e8f4fd', border: '#b8d4f0', text: '#2c5282', headerBg: '#3182ce', headerText: '#fff' },  // Blue
            { bg: '#fef3e8', border: '#f5d5b0', text: '#975a16', headerBg: '#dd6b20', headerText: '#fff' },  // Orange
            { bg: '#f0e8f8', border: '#d4c0e8', text: '#6b46a0', headerBg: '#805ad5', headerText: '#fff' },  // Purple
            { bg: '#e8f8f0', border: '#b8e8d0', text: '#276749', headerBg: '#38a169', headerText: '#fff' },  // Green
            { bg: '#fde8e8', border: '#f0b8b8', text: '#c53030', headerBg: '#e53e3e', headerText: '#fff' },  // Red
            { bg: '#f8f8e8', border: '#e8e8b8', text: '#7b7b16', headerBg: '#b7a429', headerText: '#fff' },  // Yellow
            { bg: '#e8f0f8', border: '#b8d0e8', text: '#2b4a6b', headerBg: '#4a6fa5', headerText: '#fff' },  // Steel blue
            { bg: '#f8e8f0', border: '#e8b8d0', text: '#9b2c5c', headerBg: '#d53f8c', headerText: '#fff' },  // Pink
        ];

        function getStoreColor(storeId, forHeader = false) {
            if (!storeId) return { bg: '#f5f5f5', border: '#e0e0e0', text: '#666', headerBg: '#888', headerText: '#fff' };
            const index = (storeId - 1) % storeColors.length;
            return storeColors[index];
        }

        function getInitials(name) {
            if (!name) return '';
            return name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
        }

        function render() {
            // Render store tabs first
            renderStoreTabs();

            // Get filtered items
            const filteredList = getFilteredItems(listItems);
            const filteredFrequent = getFilteredItems(frequentItems);

            // Render shopping list
            const listEl = document.getElementById('shoppingList');
            document.getElementById('listCount').textContent = `${filteredList.length} item${filteredList.length !== 1 ? 's' : ''}`;

            if (filteredList.length === 0) {
                listEl.innerHTML = selectedStoreFilter === 'all'
                    ? '<li class="empty-state">Your shopping list is empty. Add items above!</li>'
                    : '<li class="empty-state">No items for this store.</li>';
            } else {
                // Group items by store
                const grouped = {};
                filteredList.forEach(item => {
                    const storeKey = item.store_name || '_nostore';
                    if (!grouped[storeKey]) grouped[storeKey] = [];
                    grouped[storeKey].push(item);
                });

                // Sort store names, put "No store" at the end
                const storeOrder = Object.keys(grouped).sort((a, b) => {
                    if (a === '_nostore') return 1;
                    if (b === '_nostore') return -1;
                    return a.localeCompare(b);
                });

                let html = '';
                storeOrder.forEach((storeKey, storeIndex) => {
                    const items = grouped[storeKey];
                    const storeName = storeKey === '_nostore' ? 'No Store' : storeKey;
                    const storeId = items[0]?.store_id;
                    const storeColor = getStoreColor(storeId);

                    // Only show store header if viewing all stores and there are multiple stores
                    if (selectedStoreFilter === 'all' && storeOrder.length > 1) {
                        html += `<li class="store-group-header" style="background: ${storeColor.headerBg}; color: ${storeColor.headerText};">${escapeHtml(storeName)} <span class="store-group-count" style="background: rgba(255,255,255,0.25);">${items.length}</span></li>`;
                    }

                    html += items.map(item => {
                        const hasDetails = item.notes;
                        const itemColor = getStoreColor(item.store_id);
                        const showStoreOnItem = selectedStoreFilter !== 'all' || storeOrder.length === 1;
                        return `
                        <li class="list-item" style="flex-wrap: wrap; background: ${itemColor.bg}; border-left: 3px solid ${itemColor.border};">
                            <div class="item-info">
                                <div class="item-name">${escapeHtml(item.name)}${hasDetails ? '<span class="has-details-indicator" title="Has notes"></span>' : ''}</div>
                                <div class="item-meta">
                                    ${showStoreOnItem ? `<span class="item-badge" style="background:${itemColor.border};color:${itemColor.text};cursor:pointer;" onclick="showStoreDropdown(event, ${item.id}, ${item.store_id || 'null'})">${item.store_name ? escapeHtml(item.store_name) : 'No store'}</span>` : ''}
                                    ${item.occasional ? `<span class="item-badge occasional-badge">Occasional</span>` : ''}
                                    ${item.added_by_name ? `<span class="item-badge user-badge" title="${escapeHtml(item.added_by_name)}">${getInitials(item.added_by_name)}</span>` : ''}
                                    ${!item.occasional ? `<span class="frequency" onclick="showFrequencyDropdown(event, ${item.id}, ${item.target_frequency || 'null'})">${item.target_frequency ? formatFrequency(item.target_frequency) : (item.frequency_days ? formatFrequency(item.frequency_days) : 'Set frequency')}</span>` : ''}
                                    ${!item.occasional && item.target_frequency && item.frequency_days && item.frequency_days !== item.target_frequency ? `<span class="frequency-target">(actual: ${formatFrequency(item.frequency_days)})</span>` : ''}
                                    ${item.purchase_count > 0 ? `<span>Ã—${item.purchase_count}</span>` : '<span>New</span>'}
                                    ${item.current_price ? `<span class="price">$${item.current_price.toFixed(2)}</span>` : ''}
                                </div>
                                ${item.last_purchased ? `<div class="item-meta last-purchased">${formatLastPurchased(item.last_purchased)}</div>` : ''}
                                ${item.notes ? `<div class="item-meta" style="margin-top:4px;font-style:italic;color:#666;">${escapeHtml(item.notes).substring(0, 50)}${item.notes.length > 50 ? '...' : ''}</div>` : ''}
                            </div>
                            <div class="item-primary-actions">
                                <div class="menu-wrapper">
                                    <button class="item-menu-btn" onclick="toggleItemMenu(event, ${item.id})">â€¢â€¢â€¢</button>
                                    <div class="item-menu" id="menu-${item.id}" style="display:none;left:auto;">
                                        <button class="item-menu-option" onclick="toggleDetails(${item.id}); closeItemMenu();">ðŸ“ Notes</button>
                                        <button class="item-menu-option" onclick="editItem(${item.id}, '${escapeHtml(item.name).replace(/'/g, "\\'")}'); closeItemMenu();">âœï¸ Edit Name</button>
                                        ${item.purchase_count > 0 ? `<button class="item-menu-option" onclick="showHistory(${item.id}, '${escapeHtml(item.name)}'); closeItemMenu();">ðŸ“Š History</button>` : ''}
                                        <button class="item-menu-option delete" onclick="deleteItem(${item.id}); closeItemMenu();">ðŸ—‘ï¸ Delete</button>
                                    </div>
                                </div>
                                <button class="na-btn" onclick="markNotAvailable(${item.id})">N/A</button>
                                <button class="bought-btn" onclick="markBought(${item.id})">Bought âœ“</button>
                            </div>
                            <div class="item-details" id="details-${item.id}">
                                <div class="item-details-row">
                                    <label>Notes</label>
                                    <textarea id="notes-${item.id}" placeholder="Add notes about this item...">${item.notes ? escapeHtml(item.notes) : ''}</textarea>
                                </div>
                                <button class="save-details-btn" onclick="saveDetails(${item.id})">Save</button>
                            </div>
                        </li>
                    `}).join('');
                });

                listEl.innerHTML = html;
            }

            // Render Buy Again section
            const buyAgainSection = document.getElementById('buyAgainSection');
            const frequentEl = document.getElementById('frequentItems');

            if (filteredFrequent.length === 0) {
                buyAgainSection.style.display = 'none';
            } else {
                buyAgainSection.style.display = 'block';

                // Sort by due date (overdue first)
                const sorted = [...filteredFrequent].sort((a, b) => {
                    const aDays = getDaysUntilDue(a.next_purchase);
                    const bDays = getDaysUntilDue(b.next_purchase);
                    if (aDays === null && bDays === null) return b.purchase_count - a.purchase_count;
                    if (aDays === null) return 1;
                    if (bDays === null) return -1;
                    return aDays - bDays;
                });

                frequentEl.innerHTML = sorted.map(item => {
                    const dueText = formatDueDate(item.next_purchase);
                    const daysUntil = getDaysUntilDue(item.next_purchase);
                    const isDueSoon = daysUntil !== null && daysUntil <= 3;

                    return `
                        <div class="frequent-item ${isDueSoon ? 'due-soon' : ''}" onclick="addToList(${item.id})">
                            <div>
                                <div class="name">${escapeHtml(item.name)}${item.store_name ? ` <span style="font-size:10px;color:#1565c0;">(${escapeHtml(item.store_name)})</span>` : ''}</div>
                                <div class="stats">
                                    ${dueText ? dueText : (item.frequency_days ? formatFrequency(item.frequency_days) : `${item.purchase_count}x bought`)}
                                </div>
                            </div>
                            <button class="add-btn">+</button>
                        </div>
                    `;
                }).join('');
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Close modal on outside click
        document.getElementById('historyModal').addEventListener('click', e => {
            if (e.target.id === 'historyModal') closeModal();
        });
        document.getElementById('manageModal').addEventListener('click', e => {
            if (e.target.id === 'manageModal') closeManageModal();
        });

        fetchData();
    </script>
</body>
</html>
